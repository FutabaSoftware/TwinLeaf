---
title: ツリー構造整理手順
date: 2025-06-20 14:02
---

# ツリー構造整理手順

### assistant  

了解。Excelのセル数式だけで、F列の「パーツ構成」パスから空白を詰めて階層ごとに直接「レベル1」〜「レベル5」の各セルに分割表示する方法を示す。

---

## 【Excel数式のみで空白詰めしながら階層分割（レベル1～5）】

例：  
F2セルに  
`\作業ステージ\作業ステージ\ステージ扉_A\扉\角鋼_30302`  

のようなパスがある場合に

G2：レベル1  
H2：レベル2  
I2：レベル3  
J2：レベル4  
K2：レベル5

に空白を詰めて階層名を入れる。

---

### 1. まず「パーツ構成」を配列として分解

```excel
=FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s")
```

これで分解された配列が得られる（Excel 365で動作）。

---

### 2. 空白を詰めて左に詰める数式（G2に）

```excel
=LET(
  parts, FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s"),
  filtered, FILTER(parts, parts<>""),  /* 空白を除去 */
  INDEX(filtered, 1)
)
```

これはレベル1の要素。

---

### 3. レベル2～5は同様にINDEXの数字だけ変える（H2～K2）

```excel
=LET(
  parts, FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s"),
  filtered, FILTER(parts, parts<>""), 
  IF(COLUMNS($G2:G2) <= COUNTA(filtered), INDEX(filtered, COLUMNS($G2:G2)), "")
)
```

これはG2に入れ、右方向にコピー（H2,I2,J2,K2）すると、レベル1～5が自動で埋まる。

---

### 4. まとめ

- G2に上記3の式を入れて右方向5列にコピーするだけで  
- F列のパーツ構成が空白詰めされた形でレベル1～5に分割される  
- Excel 365（FILTERXML, FILTER, LET関数対応版）専用

---

### 5. Excel365以外の場合

FILTER関数やLET関数が使えない場合はかなり複雑になるため、ご希望あれば別案（VBAやPower Queryなど）を提案します。

---

もし手元のExcelバージョンや不明点あれば教えてください。すぐ使える式でサポートします。

### assistant  

了解。  
「重量まとめ」シートに以下を反映したいということと解釈した：

---

### ✅ 目的（まとめ）

- **「作業ステージ」シート**のF列「パーツ構成」から階層分割（空白なし左詰め）を行い  
- 各パーツの **モデル重量（列E）** を
- **「重量まとめ」シート**に、**全ての部品（"その他"も含めて）**の重さを階層ごとに集計する

---

### ✅ イメージ（重量まとめシート）

| レベル1       | レベル2       | レベル3          | レベル4 | レベル5      | 重量合計 (g) |
|---------------|---------------|------------------|---------|--------------|--------------|
| 作業ステージ   | 作業ステージ   | ステージ扉_A     | 扉      | 角鋼_30302   | 5,184        |
| 作業ステージ   | 作業ステージ   | ステージ扉_B     | ロック座|              | 9,277        |
| 作業ステージ   | 作業ステージ   | カーゴストッパー |         |              | 38,160       |
| 作業ステージ   | その他         |                  |         |              | 6,750        |
| …             | …             | …                | …       | …            | …            |

---

### ✅ 実現方法（概要）

1. **作業ステージシート**で以下を準備  
   - パーツ構成（F列）を `\` で分割して「レベル1〜5列」を作る（前述の数式使用）  
   - モデル重量（E列）をコピーしておく

2. 新しい「重量まとめ」シートで  
   - レベル1〜5列を含むテーブルを作成し、  
   - **すべての行**で、同じ階層構成ごとに**重量（E列）を合計**する（`SUMIFS` or ピボットテーブル）

---

### ✅ 方法詳細（自動で作りたい場合）

#### 作業ステージシートで数式

例：G列～K列にレベル1〜5（空白詰め）の階層  
L列に重量（E列）をそのままコピー

G2に入れる式（レベル1〜5左詰め、Excel365用）：

```excel
=LET(
  parts, FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s"),
  filtered, FILTER(parts, parts<>""), 
  IF(COLUMNS($G2:G2) <= COUNTA(filtered), INDEX(filtered, COLUMNS($G2:G2)), "")
)
```

→ G2に入れて右へ5列コピー（G:H:I:J:K）

#### 重量列（L列）

```excel
=E2
```

---

#### 重量まとめシート（ピボットテーブル推奨）

1. G〜L列までを範囲としてピボットテーブルを作成  
2. レベル1〜5 を「行ラベル」へ  
3. モデル重量（L列）を「値」へ → **合計**

---

### ✅ 「その他も含めて」とは？

「パーツ構成」が `\作業ステージ\その他\〇〇` のようになっている場合にも同様に処理され、空白になっていない限り、すべてのパーツが重量集計対象になる。

---

### ✅ 出力希望？

以下のどれで出したいか教えて：

- [ ] Excelファイルに自動で反映（可能であればファイル再アップ）
- [ ] ピボットではなく「SUMIFS」で静的な表にしたい
- [ ] VBAで自動処理したい
- [ ] PowerQueryで集計したい

希望に応じて具体的なファイルや式を書く。どこまで自動化したいか教えて。

### user  

重量まとめシートにその他も含めて

### user  

これを引き継いで：コンテンツへとスキップする
チャット履歴

あなた:
作業ステージ_04.xlsx
スプレッドシート
F列を参考にしてデータを整理したい
ChatGPT:
ファイル 作業ステージ_04.xlsx を受け取りました。

「F列を参考にしてデータを整理したい」とのことですが、以下の点についてもう少し具体的に教えてもらえますか？

どのシートを対象にしたいか（複数シートがある場合）

F列には何が書かれていて、どのように整理したいか（例：「同じカテゴリごとにまとめたい」「空欄の行を除外したい」「F列の値で並び替えたい」など）

出力形式（例：フィルター済みの表を作りたい、別のファイルに抽出したい など）

要望を元にすぐに処理できます。

あなた:
「作業ステージ」シート
ChatGPT:
「作業ステージ」シートを確認したところ、以下のような列がありました：

No.

階層

部品名

合計

モデル重量

パーツ構成

おそらく、F列（= パーツ構成列）をもとに「階層構造」や「親子関係」に沿って整理したいのだと推測します。

例えば、以下のような整理が考えられます：

階層構造をツリー状に表示したい

親部品ごとにまとめたい（例：\作業ステージ\作業ステージ の直下の部品だけを抽出）

特定の階層だけ抽出（例：階層=3の部品だけ）

F列の構成パスに基づいて並び替えやインデントを加えた一覧を作成したい

どう整理したいですか？ 具体例や目的を教えてもらえると、すぐ処理可能です。 

あなた:
階層構造をツリー状に表示したい
ChatGPT:
階層構造に基づき、パーツをツリー状に整理しました。
以下がその一部（上位20件）です：

No.	階層	ツリー表示	合計	モデル重量
1	1	作業ステージ	1	1,823,305
2	2	　作業ステージ	1	1,813,628
14	3	　　カーゴストッパー	1	38,160
8	3	　　ステージ扉_A	1	29,413
112	4	　　　ストッパー	7	149,520
113	4	　　　SC140-06761_BLL-100_____	1	54,081
114	4	　　　SC140-06762_BLL-100__{__	1	44,984
116	4	　　　扉	1	27,432
118	5	　　　　角鋼_30302	5	5,184
インデントは「全角スペース」で表現し、階層が深いほど右にずれます。
この一覧を Excelファイルとして出力することも可能です。出力希望なら伝えてください。 

あなた:
Excelファイルとして出力
ChatGPT:
ツリー構造に整理したデータを以下のExcelファイルとして出力しました：

👉 作業ステージ_ツリー構造.xlsx をダウンロード

他にもフィルタや絞り込みなど希望があれば知らせてください。 

あなた:
ツリー分けされているものをセルで管理したい
ChatGPT:
了解。
「ツリー分けされているものをセルで管理したい」というのは、おそらく以下のような形式を指していると考えます：

✅ 目的イメージ（例）
レベル1	レベル2	レベル3	レベル4	レベル5	合計	モデル重量
作業ステージ	作業ステージ	ステージ扉_A	扉	角鋼_30302	1	5,184
作業ステージ	作業ステージ	ステージ扉_B	ロック座		1	9,277
このように、「\作業ステージ\作業ステージ\ステージ扉_A\扉\角鋼_30302」 のような階層構成を、各階層ごとに列で分けて整理したい、という意味であればすぐ可能です。

この形式でExcel出力してよい？（OKならそのまま出力する）
もし他の形式が希望なら教えて。

あなた:
OK
ChatGPT:
It seems like I can’t do more advanced data analysis right now. Please try again later.

もし急ぎで「階層をセルに分けたExcelファイル」が必要であれば、手順を以下に記載するので、自分で処理することも可能です。希望があれば伝えてください。それ以外にも、再実行可能になったら続きます。 

あなた:
手順を教えて
ChatGPT:
以下は、Excel で「パーツ構成」列を階層ごとにセル分割する方法です（例：「\作業ステージ\作業ステージ\ステージ扉_A\扉\角鋼_30302」を分解）：

✅ Excelで階層分割する手順（手作業）
1. パーツ構成列のコピー
F列の「パーツ構成」列（例：\作業ステージ\作業ステージ\ステージ扉_A）を新しい列にコピー（例えば G列）

2. 先頭の \ を削除
G列全体を選択し、Ctrl + H（検索と置換）を開く

検索する文字列： \

置換後の文字列：（空欄）

→ 「すべて置換」

※これで \ が削除され、作業ステージ\作業ステージ\ステージ扉_A のような形式になる

3. 区切り位置で列分割
G列を選択した状態で、メニューの「データ」→「区切り位置」をクリック

区切り文字を「その他」にし、「\」を指定

OKを押すと、階層ごとに別の列に分割される（例：H列：レベル1、I列：レベル2…）

4. 列名を付ける（任意）
H列～ の各列に「レベル1」「レベル2」などの見出しをつけると見やすくなる

🔁 オプション：合計や重量などと併せて表示
元の「合計」や「モデル重量」列も隣に表示しておくと管理しやすい

✅ 補足
大量のデータがある場合や定期的にやる場合は、Power QueryやVBAで自動化も可能です。希望があれば方法を案内します。

やってみてうまくいかないところがあれば、スクリーンショットや該当の行を書いてくれればフォローする。

あなた:
セルに入力する数式で
ChatGPT:
了解。以下は、F列にある「パーツ構成」文字列をセル数式だけで階層ごとに分割する方法です。
例：
F2 = \作業ステージ\作業ステージ\ステージ扉_A\扉\角鋼_30*30*2

✅ セル数式で階層ごとに分割（最大5階層を想定）
各列に以下の数式を入力してください（2行目を例とします）：

🔹 G列：レベル1
=IFERROR(INDEX(FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s"), 1), "")
🔹 H列：レベル2
=IFERROR(INDEX(FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s"), 2), "")
🔹 I列：レベル3
=IFERROR(INDEX(FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s"), 3), "")
🔹 J列：レベル4
=IFERROR(INDEX(FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s"), 4), "")
🔹 K列：レベル5
=IFERROR(INDEX(FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s"), 5), "")
📌 ポイント
MID(F2,2,LEN(F2)) で先頭の \ を除外

SUBSTITUTE(..., "\", "</s><s>") でXML風に区切る

FILTERXML 関数で分割された要素を取得

IFERROR(..., "") で空の階層を空欄に

✅ 注意点
Excel 2013以降のバージョンで FILTERXML が使えます（Macでは非対応）

階層がもっと必要なら INDEX(..., 6) 以降を追加すればOK

うまくいかなかった場合、Excelのバージョンとエラー内容を教えてください。代替手段もあります。

あなた:
空白がないようにしたい
ChatGPT:
了解。「空白がないようにしたい」というのは、おそらく以下の意味だと考えられます：

ツリーの各階層をセルに分割する際、途中の階層が空でも、下の階層を上に詰めて左寄せ（空欄が生じない）にしたい

たとえば以下のようにしたいということ：

レベル1	レベル2	レベル3	レベル4	レベル5
作業ステージ	作業ステージ	ステージ扉_A	扉	角鋼_30302
作業ステージ	作業ステージ	ロック座		
を↓

レベル1	レベル2	レベル3	レベル4	レベル5
作業ステージ	作業ステージ	ステージ扉_A	扉	角鋼_30302
作業ステージ	作業ステージ	ロック座		
ではなく、

レベル1	レベル2	レベル3	レベル4	レベル5
作業ステージ	作業ステージ	ステージ扉_A	扉	角鋼_30302
作業ステージ	作業ステージ	ロック座		
のように、空欄がある行の下位階層要素を左に詰めたいということですね。

✅ 解決策（空欄を詰めて左から並べる）
1. G2セルに以下を入力：
=TEXTJOIN(",", TRUE, IFERROR(INDEX(FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s"), SEQUENCE(1,10)), ""))
これは、F列の階層パス（例：\作業ステージ\作業ステージ\ロック座）を、区切り記号「,」で左詰めで並べた1つの文字列に変換します。
結果例：
作業ステージ,作業ステージ,ロック座

2. G列をカンマで区切って列に展開
G列を選択し、「データ」→「区切り位置」

区切り文字「カンマ」で区切る

すると、空白がなく左から階層順に並びます。

✅ まとめ
方法	メリット	デメリット
FILTERXML+INDEX	各階層を個別に管理できる	空欄ができやすい
TEXTJOIN+区切り	自動で左詰めされて整う	区切ったあとは手動で列に展開が必要
もし すべて数式のみで「レベル1～5の各列」に直接左詰め結果を出したいなら、それも対応可能。希望があればそちらの式も書く。

あなた:
表で出力して
ChatGPT:
以下は、F列の「パーツ構成」（例：\作業ステージ\作業ステージ\ステージ扉_A\扉\角鋼_30*30*2）を、空白が出ないように左詰めした状態で分割した表です。
各階層は「レベル1」〜「レベル5」として表示します。

✅ 出力サンプル（空白を左に詰めた階層構造）
レベル1	レベル2	レベル3	レベル4	レベル5
作業ステージ	作業ステージ	ステージ扉_A	扉	角鋼_30302
作業ステージ	作業ステージ	カーゴストッパー		
作業ステージ	作業ステージ	ステージ扉_B	ロック座	
作業ステージ	作業ステージ	階段		
作業ステージ	作業ステージ	ステージ扉_A	扉	
作業ステージ	作業ステージ	ステージ扉_A	扉	M4
✅ この表を Excel で作るには：
1. セルに以下の式を使って左詰め文字列を生成（例：G2）
=TEXTJOIN(",", TRUE, IFERROR(INDEX(FILTERXML("<t><s>"&SUBSTITUTE(MID(F2,2,LEN(F2)),"\", "</s><s>")&"</s></t>", "//s"), SEQUENCE(1,10)), ""))
2. G列を「カンマ」で列に分割する：
G列を選択 → [データ] タブ → [区切り位置] → 区切り文字「カンマ」

このようにすれば、空白を飛ばして階層構造を左から順にセルで表示できます。
より自動化したい（関数のみでレベル1〜5列に直接出したい）場合は、その式も提示可能。希望あれば伝えて。

GPT-4o. の Free プランの制限に達しました。
このチャットには添付ファイルがあるため、続行するには GPT-4o が必要です。制限が 18:25 以降. にリセットされます

新しいチャット

Plus を入手

より自動化したい


選択されていません選択されていません
ChatGPT の回答は必ずしも正しいとは限りません。重要な情報は確認するようにしてください。
